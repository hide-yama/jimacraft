<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>jimacraft</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }

        h1 {
            text-align: center;
            color: #222;
            margin-bottom: 10px;
            font-size: 2.6em;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 500;
            letter-spacing: 0.04em;
        }

        .subtitle-header {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
            font-size: 0.9em;
        }

        /* ステップセクション */
        .step-section {
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            transition: box-shadow 0.3s;
        }

        .step-section:hover {
            box-shadow: 0 1px 6px rgba(0,0,0,0.04);
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 18px;
        }

        .step-number {
            background: #333;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1em;
            flex-shrink: 0;
        }

        .step-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        /* テキストエリア */
        textarea {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            font-family: 'Courier New', Consolas, monospace;
            font-size: 13px;
            line-height: 1.5;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #333;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.08);
        }

        /* ボタン */
        .btn {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #333;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #555;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e0e0e0;
        }

        .btn-success {
            background: #444;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #333;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        /* 統計情報 */
        .stats {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px 18px;
            margin-top: 12px;
            font-size: 0.9em;
            color: #555;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stat-label {
            color: #888;
        }

        .stat-value {
            font-weight: bold;
            color: #333;
        }

        /* マーカー説明 */
        .marker-help {
            background: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 14px 18px;
            margin-bottom: 14px;
            font-size: 0.88em;
            line-height: 1.8;
        }

        .marker-help code {
            background: #eee;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', Consolas, monospace;
            font-weight: bold;
        }

        /* 結果表示 */
        .result-area {
            display: none;
            margin-top: 15px;
        }

        .result-area.visible {
            display: block;
        }

        .result-label {
            font-weight: 600;
            color: #555;
            margin-bottom: 6px;
            font-size: 0.9em;
        }

        /* 進むボタン */
        .next-step-btn {
            display: none;
            margin-top: 15px;
        }

        .next-step-btn.visible {
            display: block;
        }

        /* 話者タブ */
        .speaker-tabs {
            display: flex;
            gap: 2px;
            margin-bottom: 0;
            flex-wrap: wrap;
        }

        .speaker-tab {
            padding: 8px 18px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .speaker-tab.active {
            background: white;
            border-color: #333;
            border-bottom: 2px solid white;
            color: #333;
            font-weight: bold;
            margin-bottom: -1px;
        }

        .speaker-tab .count-badge {
            background: #eee;
            color: #666;
            padding: 1px 7px;
            border-radius: 10px;
            font-size: 0.8em;
            margin-left: 5px;
        }

        .speaker-tab.active .count-badge {
            background: #333;
            color: white;
        }

        .speaker-content {
            border: 1px solid #ddd;
            border-radius: 0 8px 8px 8px;
            padding: 15px;
        }

        .speaker-srt {
            display: none;
        }

        .speaker-srt.active {
            display: block;
        }

        /* ローディング */
        .loading {
            display: none;
            align-items: center;
            gap: 10px;
            margin-top: 12px;
            color: #333;
        }

        .loading.visible {
            display: flex;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #ddd;
            border-top-color: #333;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* エラー表示 */
        .error-msg {
            display: none;
            background: #fff3f3;
            border: 1px solid #fcc;
            color: #c33;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 0.9em;
        }

        .error-msg.visible {
            display: block;
        }

        /* フッター */
        .footer {
            text-align: center;
            color: rgba(255,255,255,0.6);
            font-size: 0.8em;
            margin-top: 20px;
        }

        /* ===== 準備ガイド ===== */

        /* 初期選択カード */
        .prep-selection {
            text-align: center;
            margin-bottom: 25px;
        }

        .prep-selection h2 {
            font-size: 1.15em;
            color: #333;
            margin-bottom: 18px;
            font-weight: 600;
        }

        .prep-cards {
            display: flex;
            gap: 14px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .prep-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px 24px;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            min-width: 140px;
            max-width: 200px;
            text-align: center;
        }

        .prep-card:hover {
            border-color: #333;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        .prep-card.selected {
            border-color: #333;
            background: #f5f5f5;
        }

        .prep-card-icon {
            margin-bottom: 10px;
        }

        .prep-card-icon svg {
            width: 36px;
            height: 36px;
            stroke: #555;
            fill: none;
            stroke-width: 1.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .prep-card-title {
            font-weight: bold;
            color: #333;
            font-size: 0.95em;
        }

        .prep-card-desc {
            color: #888;
            font-size: 0.8em;
            margin-top: 4px;
        }

        /* 選択済みバー（折りたたみ時） */
        .prep-selected-bar {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 10px 18px;
            margin-bottom: 20px;
            font-size: 0.9em;
            color: #555;
        }

        .prep-selected-bar.visible {
            display: flex;
        }

        .prep-selected-bar a {
            color: #333;
            cursor: pointer;
            text-decoration: underline;
            font-size: 0.85em;
        }

        /* 準備ステップセクション */
        .prep-step-section {
            display: none;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            background: #fafafa;
        }

        .prep-step-section.visible {
            display: block;
        }

        .prep-step-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 18px;
        }

        .prep-step-badge {
            background: #666;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            white-space: nowrap;
        }

        .prep-step-title {
            font-size: 1.15em;
            font-weight: bold;
            color: #333;
        }

        /* サブステップ */
        .substep {
            display: none;
        }

        .substep.active {
            display: block;
        }

        .substep-indicator {
            display: flex;
            gap: 8px;
            margin-bottom: 18px;
        }

        .substep-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ddd;
            transition: background 0.3s;
        }

        .substep-dot.active {
            background: #333;
        }

        .substep-dot.done {
            background: #444;
        }

        .substep-label {
            font-weight: 600;
            color: #555;
            margin-bottom: 12px;
            font-size: 0.95em;
        }

        /* OS切替タブ */
        .os-tabs {
            display: flex;
            gap: 2px;
            margin-bottom: 14px;
        }

        .os-tab {
            padding: 6px 16px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .os-tab.active {
            background: white;
            border-color: #333;
            color: #333;
            font-weight: bold;
        }

        .os-content {
            display: none;
        }

        .os-content.active {
            display: block;
        }

        /* コマンドブロック */
        .cmd-block {
            background: #1e1e2e;
            color: #cdd6f4;
            border-radius: 8px;
            padding: 14px 18px;
            font-family: 'Courier New', Consolas, monospace;
            font-size: 0.88em;
            line-height: 1.6;
            position: relative;
            margin-bottom: 10px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .cmd-block .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255,255,255,0.15);
            color: #cdd6f4;
            border: none;
            border-radius: 5px;
            padding: 4px 10px;
            font-size: 0.8em;
            cursor: pointer;
            transition: background 0.2s;
        }

        .cmd-block .copy-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .cmd-note {
            font-size: 0.85em;
            color: #888;
            margin-top: 6px;
            margin-bottom: 14px;
        }

        /* サブステップナビ */
        .substep-nav {
            display: flex;
            gap: 10px;
            margin-top: 18px;
            justify-content: flex-end;
        }

        /* 話者入力フォーム */
        .speaker-form {
            margin-bottom: 16px;
        }

        .speaker-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .speaker-row input[type="text"] {
            flex: 1;
            min-width: 120px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .speaker-row input[type="text"]:focus {
            outline: none;
            border-color: #333;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.08);
        }

        .speaker-row select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9em;
            background: white;
        }

        .speaker-row select:focus {
            outline: none;
            border-color: #333;
        }

        .speaker-remove-btn {
            background: none;
            border: 1px solid #ddd;
            border-radius: 6px;
            color: #c33;
            cursor: pointer;
            padding: 6px 10px;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .speaker-remove-btn:hover {
            background: #fff3f3;
            border-color: #fcc;
        }

        .add-speaker-btn {
            background: none;
            border: 1px dashed #bbb;
            border-radius: 6px;
            color: #333;
            cursor: pointer;
            padding: 8px 16px;
            font-size: 0.88em;
            transition: all 0.2s;
            width: 100%;
            margin-top: 4px;
        }

        .add-speaker-btn:hover {
            background: #f8f8f8;
            border-color: #333;
        }

        .content-desc-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9em;
            margin-top: 14px;
        }

        .content-desc-input:focus {
            outline: none;
            border-color: #333;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.08);
        }

        .content-desc-label {
            font-size: 0.88em;
            color: #666;
            margin-top: 14px;
            margin-bottom: 6px;
        }

        /* 生成プロンプト表示 */
        .generated-prompt {
            display: none;
            margin-top: 16px;
        }

        .generated-prompt.visible {
            display: block;
        }

        .generated-prompt textarea {
            background: #f8f9fa;
            font-size: 0.88em;
        }

        /* 手順リスト */
        .guide-steps {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .guide-steps li {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 12px;
            font-size: 0.92em;
            color: #444;
            line-height: 1.5;
        }

        .guide-step-num {
            background: #333;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            font-weight: bold;
            flex-shrink: 0;
            margin-top: 1px;
        }

        .guide-link {
            color: #333;
            text-decoration: underline;
        }

        /* ===== 認証・プラン関連 ===== */

        /* ログインオーバーレイ */
        .login-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(245, 245, 245, 0.97);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-overlay.hidden {
            display: none;
        }

        .login-box {
            text-align: center;
            background: white;
            padding: 48px 40px;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            max-width: 400px;
            width: 90%;
        }

        .login-box h2 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 2em;
            font-weight: 500;
            color: #222;
            margin-bottom: 8px;
        }

        .login-box p {
            color: #888;
            font-size: 0.95em;
            margin-bottom: 28px;
        }

        .google-login-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: #333;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 32px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .google-login-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .google-login-btn svg {
            width: 20px;
            height: 20px;
        }

        /* 認証バー */
        .auth-bar {
            display: none;
            align-items: center;
            gap: 12px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 10px 16px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }

        .auth-bar.visible {
            display: flex;
        }

        .auth-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #eee;
        }

        .auth-name {
            font-weight: 600;
            color: #333;
        }

        .auth-plan-badge {
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .auth-plan-badge.free {
            background: #f0f0f0;
            color: #888;
        }

        .auth-plan-badge.plus {
            background: #333;
            color: white;
        }

        .auth-plan-badge.pro {
            background: #111;
            color: white;
        }

        .auth-usage {
            color: #888;
            font-size: 0.85em;
        }

        .auth-spacer {
            flex: 1;
        }

        .auth-upgrade-btn {
            background: #333;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 14px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .auth-upgrade-btn:hover {
            background: #111;
        }

        .auth-manage-btn,
        .auth-logout-btn {
            background: none;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.85em;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }

        .auth-manage-btn:hover,
        .auth-logout-btn:hover {
            background: #f5f5f5;
        }

        /* ステップロックオーバーレイ */
        .step-lock-overlay {
            display: none;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            z-index: 100;
            border-radius: 12px;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 12px;
        }

        .step-lock-overlay.visible {
            display: flex;
        }

        .step-section {
            position: relative;
        }

        .step-lock-icon {
            width: 40px;
            height: 40px;
            stroke: #999;
            fill: none;
            stroke-width: 1.5;
        }

        .step-lock-text {
            color: #888;
            font-size: 0.95em;
            text-align: center;
        }

        .step-lock-upgrade-btn {
            background: #333;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 20px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .step-lock-upgrade-btn:hover {
            background: #111;
        }

        /* 料金モーダル */
        .pricing-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 20000;
            align-items: center;
            justify-content: center;
        }

        .pricing-overlay.visible {
            display: flex;
        }

        .pricing-modal {
            background: white;
            border-radius: 16px;
            padding: 36px;
            max-width: 780px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .pricing-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            font-size: 1.5em;
            color: #999;
            cursor: pointer;
            line-height: 1;
        }

        .pricing-close:hover {
            color: #333;
        }

        .pricing-title {
            text-align: center;
            font-size: 1.4em;
            font-weight: bold;
            color: #222;
            margin-bottom: 6px;
        }

        .pricing-subtitle {
            text-align: center;
            color: #888;
            font-size: 0.9em;
            margin-bottom: 20px;
        }

        /* 月払い/年払い切替 */
        .billing-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 24px;
            font-size: 0.9em;
        }

        .billing-toggle-label {
            color: #888;
        }

        .billing-toggle-label.active {
            color: #333;
            font-weight: 600;
        }

        .billing-toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: #ddd;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .billing-toggle-switch.yearly {
            background: #333;
        }

        .billing-toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
        }

        .billing-toggle-switch.yearly::after {
            transform: translateX(20px);
        }

        .billing-save-badge {
            background: #333;
            color: white;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 0.8em;
            font-weight: bold;
        }

        /* プランカード */
        .pricing-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        @media (max-width: 640px) {
            .pricing-cards {
                grid-template-columns: 1fr;
            }
        }

        .pricing-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 24px 20px;
            text-align: center;
            transition: all 0.2s;
        }

        .pricing-card.current {
            border-color: #333;
        }

        .pricing-card-name {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }

        .pricing-card-price {
            font-size: 1.8em;
            font-weight: bold;
            color: #222;
            margin-bottom: 2px;
        }

        .pricing-card-price span {
            font-size: 0.4em;
            font-weight: normal;
            color: #888;
        }

        .pricing-card-billing {
            font-size: 0.8em;
            color: #888;
            margin-bottom: 16px;
        }

        .pricing-card-features {
            text-align: left;
            list-style: none;
            padding: 0;
            margin: 0 0 20px 0;
            font-size: 0.88em;
            color: #555;
        }

        .pricing-card-features li {
            padding: 4px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pricing-card-features li::before {
            content: '';
            display: inline-block;
            width: 16px;
            height: 16px;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2'%3E%3Cpolyline points='20 6 9 17 4 12'/%3E%3C/svg%3E") center/contain no-repeat;
            flex-shrink: 0;
        }

        .pricing-card-btn {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pricing-card-btn.current {
            background: #f0f0f0;
            color: #888;
            border: 1px solid #ddd;
            cursor: default;
        }

        .pricing-card-btn.upgrade {
            background: #333;
            color: white;
            border: none;
        }

        .pricing-card-btn.upgrade:hover {
            background: #111;
        }
    </style>
</head>
<body>
    <!-- ログインオーバーレイ -->
    <div class="login-overlay" id="login-overlay">
        <div class="login-box">
            <h2>jimacraft</h2>
            <p>文字起こしテキストからSRT字幕ファイルを生成</p>
            <button class="google-login-btn" onclick="loginWithGoogle()">
                <svg viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.27-4.74 3.27-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                Google でログイン
            </button>
        </div>
    </div>

    <!-- 料金モーダル -->
    <div class="pricing-overlay" id="pricing-overlay">
        <div class="pricing-modal">
            <button class="pricing-close" onclick="closePricing()">&times;</button>
            <div class="pricing-title">プランを選択</div>
            <div class="pricing-subtitle">あなたの制作ワークフローに合ったプランを</div>

            <div class="billing-toggle">
                <span class="billing-toggle-label active" id="billing-monthly-label">月払い</span>
                <div class="billing-toggle-switch" id="billing-toggle" onclick="toggleBilling()"></div>
                <span class="billing-toggle-label" id="billing-yearly-label">年払い</span>
                <span class="billing-save-badge">2ヶ月分お得</span>
            </div>

            <div class="pricing-cards" id="pricing-cards">
                <!-- JS で動的生成 -->
            </div>
        </div>
    </div>

    <div class="container">
        <!-- 認証バー -->
        <div class="auth-bar" id="auth-bar">
            <img class="auth-avatar" id="auth-avatar" src="" alt="">
            <span class="auth-name" id="auth-name"></span>
            <span class="auth-plan-badge free" id="auth-plan-badge">FREE</span>
            <span class="auth-usage" id="auth-usage"></span>
            <div class="auth-spacer"></div>
            <button class="auth-upgrade-btn" id="auth-upgrade-btn" onclick="openPricing()">アップグレード</button>
            <button class="auth-manage-btn" id="auth-manage-btn" onclick="openPortal()" style="display:none;">契約管理</button>
            <button class="auth-logout-btn" onclick="logout()">ログアウト</button>
        </div>

        <h1>jimacraft</h1>
        <p class="subtitle-header">文字起こしテキストからSRT字幕ファイルを生成</p>

        <!-- ===== 初期選択 ===== -->
        <div class="prep-selection" id="prep-selection">
            <h2>まず、お手元にあるものを選んでください</h2>
            <div class="prep-cards">
                <div class="prep-card" onclick="selectPrepType('mp4')">
                    <div class="prep-card-icon"><svg viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="2"/><polygon points="10,8 16,12 10,16"/></svg></div>
                    <div class="prep-card-title">MP4動画ファイル</div>
                    <div class="prep-card-desc">まだ変換していない</div>
                </div>
                <div class="prep-card" onclick="selectPrepType('mp3')">
                    <div class="prep-card-icon"><svg viewBox="0 0 24 24"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg></div>
                    <div class="prep-card-title">MP3音声ファイル</div>
                    <div class="prep-card-desc">音声は抽出済み</div>
                </div>
                <div class="prep-card" onclick="selectPrepType('text')">
                    <div class="prep-card-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="8" y1="13" x2="16" y2="13"/><line x1="8" y1="17" x2="13" y2="17"/></svg></div>
                    <div class="prep-card-title">文字起こしテキスト</div>
                    <div class="prep-card-desc">文字起こし済み</div>
                </div>
            </div>
        </div>

        <!-- 選択済みバー -->
        <div class="prep-selected-bar" id="prep-selected-bar">
            <span id="prep-selected-label"></span>
            <a onclick="resetPrepSelection()">選び直す</a>
        </div>

        <!-- ===== 準備1: MP4→MP3変換ガイド ===== -->
        <div class="prep-step-section" id="prep1-section">
            <div class="prep-step-header">
                <div class="prep-step-badge">準備 1</div>
                <div class="prep-step-title">MP4 → MP3 変換</div>
            </div>

            <div class="substep-indicator" id="prep1-indicator">
                <div class="substep-dot active"></div>
                <div class="substep-dot"></div>
                <div class="substep-dot"></div>
            </div>

            <!-- サブステップ 1-1: ffmpegインストール -->
            <div class="substep active" data-prep="1" data-substep="0">
                <div class="substep-label">ffmpeg のインストール確認</div>

                <div class="os-tabs">
                    <div class="os-tab active" onclick="switchOS(this, 'mac', 'prep1-install')">Mac</div>
                    <div class="os-tab" onclick="switchOS(this, 'win', 'prep1-install')">Windows</div>
                </div>

                <div id="prep1-install-mac" class="os-content active">
                    <p style="font-size:0.9em;color:#555;margin-bottom:8px;">ターミナルで以下を実行してください:</p>
                    <div class="cmd-block" id="cmd-brew-ffmpeg">brew install ffmpeg<button class="copy-btn" onclick="copyCmd('cmd-brew-ffmpeg')">コピー</button></div>
                    <div class="cmd-note">Homebrew がない場合は先に <code>brew</code> をインストールしてください。</div>
                </div>

                <div id="prep1-install-win" class="os-content">
                    <p style="font-size:0.9em;color:#555;margin-bottom:8px;">コマンドプロンプトまたはPowerShellで以下を実行してください:</p>
                    <div class="cmd-block" id="cmd-winget-ffmpeg">winget install ffmpeg<button class="copy-btn" onclick="copyCmd('cmd-winget-ffmpeg')">コピー</button></div>
                    <div class="cmd-note">または <a href="https://ffmpeg.org/download.html" target="_blank" rel="noopener" class="guide-link">公式サイト</a> からダウンロードしてPATHを通してください。</div>
                </div>

                <div class="substep-nav">
                    <button class="btn btn-primary" onclick="nextSubstep('prep1', 1)">次へ →</button>
                </div>
            </div>

            <!-- サブステップ 1-2: 変換コマンド -->
            <div class="substep" data-prep="1" data-substep="1">
                <div class="substep-label">変換コマンドの実行</div>

                <div class="os-tabs">
                    <div class="os-tab active" onclick="switchOS(this, 'mac', 'prep1-convert')">Mac</div>
                    <div class="os-tab" onclick="switchOS(this, 'win', 'prep1-convert')">Windows</div>
                </div>

                <div id="prep1-convert-mac" class="os-content active">
                    <p style="font-size:0.9em;color:#555;margin-bottom:8px;">動画ファイルがあるフォルダで実行:</p>
                    <div class="cmd-block" id="cmd-convert-mac">ffmpeg -i input.mp4 -vn -acodec libmp3lame -q:a 2 output.mp3<button class="copy-btn" onclick="copyCmd('cmd-convert-mac')">コピー</button></div>
                </div>

                <div id="prep1-convert-win" class="os-content">
                    <p style="font-size:0.9em;color:#555;margin-bottom:8px;">動画ファイルがあるフォルダで実行:</p>
                    <div class="cmd-block" id="cmd-convert-win">ffmpeg -i input.mp4 -vn -acodec libmp3lame -q:a 2 output.mp3<button class="copy-btn" onclick="copyCmd('cmd-convert-win')">コピー</button></div>
                </div>

                <div class="cmd-note"><code>input.mp4</code> と <code>output.mp3</code> は自分のファイル名に置き換えてください。</div>

                <div class="substep-nav">
                    <button class="btn btn-secondary" onclick="prevSubstep('prep1', 0)">← 戻る</button>
                    <button class="btn btn-primary" onclick="nextSubstep('prep1', 2)">次へ →</button>
                </div>
            </div>

            <!-- サブステップ 1-3: 完了確認 -->
            <div class="substep" data-prep="1" data-substep="2">
                <div class="substep-label">MP3ファイルができましたか？</div>
                <p style="font-size:0.92em;color:#555;margin-bottom:16px;">変換が完了したら、次のステップで文字起こしを行います。</p>

                <div class="substep-nav">
                    <button class="btn btn-secondary" onclick="prevSubstep('prep1', 1)">← 戻る</button>
                    <button class="btn btn-primary" onclick="completePrepStep('prep1')">次のステップへ →</button>
                </div>
            </div>
        </div>

        <!-- ===== 準備2: 文字起こしプロンプト生成 ===== -->
        <div class="prep-step-section" id="prep2-section">
            <div class="prep-step-header">
                <div class="prep-step-badge">準備 2</div>
                <div class="prep-step-title">文字起こし（AI Studio用プロンプト生成）</div>
            </div>

            <div class="substep-indicator" id="prep2-indicator">
                <div class="substep-dot active"></div>
                <div class="substep-dot"></div>
                <div class="substep-dot"></div>
            </div>

            <!-- サブステップ 2-1: 話者情報入力 -->
            <div class="substep active" data-prep="2" data-substep="0">
                <div class="substep-label">話者情報を入力</div>

                <div class="speaker-form" id="speaker-form">
                    <div class="speaker-row" data-speaker-idx="0">
                        <input type="text" placeholder="話者名（例: 山田花子）" class="speaker-name-input">
                        <select class="speaker-gender-select">
                            <option value="男性">男性</option>
                            <option value="女性">女性</option>
                            <option value="不特定">不特定</option>
                        </select>
                        <button class="speaker-remove-btn" onclick="removeSpeakerRow(this)" title="削除">&times;</button>
                    </div>
                </div>
                <button class="add-speaker-btn" onclick="addSpeakerRow()">＋ 話者を追加</button>

                <div class="content-desc-label">内容の説明（任意）</div>
                <input type="text" class="content-desc-input" id="content-desc" placeholder="例: バラエティ番組の対談">

                <div class="substep-nav">
                    <button class="btn btn-primary" onclick="nextSubstep('prep2', 1)">次へ →</button>
                </div>
            </div>

            <!-- サブステップ 2-2: プロンプト生成 -->
            <div class="substep" data-prep="2" data-substep="1">
                <div class="substep-label">プロンプトを生成してコピー</div>

                <button class="btn btn-primary" onclick="generatePrompt()">プロンプトを生成</button>

                <div class="generated-prompt" id="generated-prompt">
                    <textarea id="prompt-output" rows="14" readonly></textarea>
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="copyText('prompt-output')">プロンプトをコピー</button>
                    </div>
                </div>

                <div class="substep-nav">
                    <button class="btn btn-secondary" onclick="prevSubstep('prep2', 0)">← 戻る</button>
                    <button class="btn btn-primary" onclick="nextSubstep('prep2', 2)">次へ →</button>
                </div>
            </div>

            <!-- サブステップ 2-3: AI Studio手順 -->
            <div class="substep" data-prep="2" data-substep="2">
                <div class="substep-label">Google AI Studio で文字起こし</div>

                <p style="font-size:0.92em;color:#555;margin-bottom:14px;">
                    <a href="https://aistudio.google.com/" target="_blank" rel="noopener" class="guide-link">Google AI Studio を開く</a>
                </p>

                <ol class="guide-steps">
                    <li><span class="guide-step-num">1</span><span>MP3ファイルをアップロード</span></li>
                    <li><span class="guide-step-num">2</span><span>先ほどコピーしたプロンプトを貼り付け</span></li>
                    <li><span class="guide-step-num">3</span><span>実行して結果を待つ</span></li>
                    <li><span class="guide-step-num">4</span><span>文字起こし結果をコピー</span></li>
                </ol>

                <div class="substep-nav">
                    <button class="btn btn-secondary" onclick="prevSubstep('prep2', 1)">← 戻る</button>
                    <button class="btn btn-primary" onclick="completePrepStep('prep2')">文字起こしが完了したら次へ →</button>
                </div>
            </div>
        </div>

        <!-- ===== STEP 1 ===== -->
        <div class="step-section" id="step1-section">
            <div class="step-header">
                <div class="step-number">1</div>
                <div class="step-title">文字起こし → SRT変換</div>
            </div>

            <textarea id="step1-input" rows="12" placeholder="文字起こしテキストを貼り付けてください&#10;&#10;例:&#10;山田花子（女性）: [0:00] 今日はよろしくお願いします。&#10;鈴木太郎（男性）: [0:05] こちらこそよろしくお願いします。"></textarea>

            <div class="btn-group">
                <button class="btn btn-primary" id="step1-btn" onclick="runStep1()">SRTに変換</button>
            </div>

            <div class="loading" id="step1-loading">
                <div class="spinner"></div>
                <span>変換中...</span>
            </div>

            <div class="error-msg" id="step1-error"></div>

            <div class="result-area" id="step1-result">
                <div class="stats" id="step1-stats"></div>
                <div class="result-label" style="margin-top: 12px;">生成されたSRT:</div>
                <textarea id="step1-output" rows="10" readonly></textarea>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="downloadText('step1-output', '字幕.srt')">SRTダウンロード</button>
                    <button class="btn btn-secondary" onclick="copyText('step1-output')">コピー</button>
                </div>
            </div>

            <div class="next-step-btn" id="step1-next">
                <button class="btn btn-primary" onclick="goToStep2()">Step 2 へ進む →</button>
            </div>
        </div>

        <!-- ===== STEP 2 ===== -->
        <div class="step-section" id="step2-section">
            <div class="step-lock-overlay" id="step2-lock">
                <svg class="step-lock-icon" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                <div class="step-lock-text">Plusプラン以上で利用できます</div>
                <button class="step-lock-upgrade-btn" onclick="openPricing()">アップグレード</button>
            </div>
            <div class="step-header">
                <div class="step-number">2</div>
                <div class="step-title">マーカー編集</div>
            </div>

            <div class="marker-help">
                <strong>編集マーカー:</strong><br>
                <code>/</code> 分割 - その位置で字幕を2つに分ける<br>
                <code>-</code> 結合 - 行末に付けると同じ話者の次の字幕と結合<br>
                <code>x</code> 削除 - 行頭に付けるとその字幕を削除<br>
                <small style="color: #999;">処理順: 削除 → 結合 → 分割</small>
            </div>

            <textarea id="step2-input" rows="14" placeholder="Step1の結果がここに入ります。マーカーを追加して編集してください。"></textarea>

            <div class="btn-group">
                <button class="btn btn-primary" id="step2-btn" onclick="runStep2()">編集を実行</button>
            </div>

            <div class="loading" id="step2-loading">
                <div class="spinner"></div>
                <span>編集処理中...</span>
            </div>

            <div class="error-msg" id="step2-error"></div>

            <div class="result-area" id="step2-result">
                <div class="stats" id="step2-stats"></div>
                <div class="result-label" style="margin-top: 12px;">編集後のSRT:</div>
                <textarea id="step2-output" rows="10" readonly></textarea>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="downloadText('step2-output', '字幕_編集済み.srt')">SRTダウンロード</button>
                    <button class="btn btn-secondary" onclick="copyText('step2-output')">コピー</button>
                </div>
            </div>

            <div class="next-step-btn" id="step2-next">
                <button class="btn btn-primary" onclick="goToStep3()">Step 3 へ進む →</button>
            </div>
        </div>

        <!-- ===== STEP 3 ===== -->
        <div class="step-section" id="step3-section">
            <div class="step-lock-overlay" id="step3-lock">
                <svg class="step-lock-icon" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                <div class="step-lock-text">Proプランで利用できます</div>
                <button class="step-lock-upgrade-btn" onclick="openPricing()">アップグレード</button>
            </div>
            <div class="step-header">
                <div class="step-number">3</div>
                <div class="step-title">話者別分割</div>
            </div>

            <textarea id="step3-input" rows="10" placeholder="Step2の結果がここに入ります。" readonly></textarea>

            <div class="btn-group">
                <button class="btn btn-primary" id="step3-btn" onclick="runStep3()">話者別に分割</button>
            </div>

            <div class="loading" id="step3-loading">
                <div class="spinner"></div>
                <span>分割処理中...</span>
            </div>

            <div class="error-msg" id="step3-error"></div>

            <div class="result-area" id="step3-result">
                <div class="stats" id="step3-stats"></div>
                <div class="speaker-tabs" id="speaker-tabs"></div>
                <div class="speaker-content" id="speaker-content"></div>
                <div class="btn-group" style="margin-top: 15px;">
                    <button class="btn btn-success" onclick="downloadAllSpeakers()">全てダウンロード</button>
                </div>
            </div>

            <div class="next-step-btn" id="step3-next">
                <button class="btn btn-primary" onclick="goToPremiere()">Premiere Pro へのインポート方法 →</button>
            </div>
        </div>

        <!-- ===== Premiere Pro インポートガイド ===== -->
        <div class="step-section" id="premiere-section">
            <div class="step-header">
                <div class="step-number" style="background: #333;">P</div>
                <div class="step-title">Premiere Pro に字幕をインポート</div>
            </div>

            <div class="marker-help" style="background:#f8f8f8;border-color:#ddd;">
                <strong>SRTファイルのインポート手順</strong><br>
                ダウンロードしたSRTファイルをPremiere Proのプロジェクトに読み込みます。
            </div>

            <ol class="guide-steps">
                <li>
                    <span class="guide-step-num">1</span>
                    <span>Premiere Pro でプロジェクトを開き、字幕を入れたいシーケンスを表示</span>
                </li>
                <li>
                    <span class="guide-step-num">2</span>
                    <span><strong>ファイル → 読み込み</strong>（Ctrl+I / Cmd+I）でSRTファイルを選択</span>
                </li>
                <li>
                    <span class="guide-step-num">3</span>
                    <span>プロジェクトパネルに読み込まれたSRTファイルを<strong>タイムラインにドラッグ&ドロップ</strong></span>
                </li>
                <li>
                    <span class="guide-step-num">4</span>
                    <span>キャプショントラックが自動生成され、字幕が配置される</span>
                </li>
            </ol>

            <div style="margin-top:18px;margin-bottom:10px;font-weight:600;color:#555;font-size:0.95em;">話者別SRTを使う場合</div>
            <ol class="guide-steps">
                <li>
                    <span class="guide-step-num">1</span>
                    <span>話者ごとのSRTファイルをそれぞれ読み込み</span>
                </li>
                <li>
                    <span class="guide-step-num">2</span>
                    <span>各SRTを別々のキャプショントラックにドラッグ（トラックが自動追加される）</span>
                </li>
                <li>
                    <span class="guide-step-num">3</span>
                    <span><strong>プロパティパネル</strong>で話者ごとにフォント・色・位置を設定</span>
                </li>
            </ol>

            <div style="margin-top:18px;margin-bottom:10px;font-weight:600;color:#555;font-size:0.95em;">字幕のスタイル調整（プロパティパネル）</div>
            <ol class="guide-steps">
                <li>
                    <span class="guide-step-num">1</span>
                    <span>画面上部のメニューバーから <strong>ウィンドウ → プロパティ</strong> をクリック</span>
                </li>
                <li>
                    <span class="guide-step-num">2</span>
                    <span>画面右側にプロパティパネルが表示される</span>
                </li>
                <li>
                    <span class="guide-step-num">3</span>
                    <span>タイムライン上の<strong>字幕クリップをクリック</strong>して選択（青くハイライトされる）</span>
                </li>
                <li>
                    <span class="guide-step-num">4</span>
                    <span>プロパティパネルに字幕の編集項目が表示されるので、ここでスタイルを変更</span>
                </li>
            </ol>
        </div>
    </div>

    <div class="footer">jimacraft</div>

    <script>
        // グローバル変数
        let speakerData = {};
        let prepType = null; // 'mp4' | 'mp3' | 'text'
        let currentUser = null;
        let currentProfile = null;
        let supabaseClient = null;
        let billingYearly = false;

        // ==================== Supabase初期化 ====================

        (function initSupabase() {
            const url = window.__SUPABASE_URL__;
            const key = window.__SUPABASE_ANON_KEY__;
            if (url && key) {
                supabaseClient = supabase.createClient(url, key);
                checkAuth();
            } else {
                // Supabase未設定 → ログイン不要モード（開発用）
                document.getElementById('login-overlay').classList.add('hidden');
            }
        })();

        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                currentUser = session.user;
                await loadProfile(session.access_token);
                onAuthReady();
            } else {
                document.getElementById('login-overlay').classList.remove('hidden');
            }

            // URLにcheckoutパラメータがある場合
            const params = new URLSearchParams(window.location.search);
            if (params.get('checkout') === 'success') {
                showToast('アップグレードが完了しました');
                window.history.replaceState({}, '', '/');
                // プロフィール再読み込み（Webhookの反映を待つ）
                setTimeout(async () => {
                    const { data: { session: s } } = await supabaseClient.auth.getSession();
                    if (s) await loadProfile(s.access_token);
                    updateAuthUI();
                    updatePlanGating();
                }, 2000);
            } else if (params.get('checkout') === 'cancel') {
                window.history.replaceState({}, '', '/');
            }

            // セッション変化を監視
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN' && session) {
                    currentUser = session.user;
                    await loadProfile(session.access_token);
                    onAuthReady();
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    currentProfile = null;
                    document.getElementById('login-overlay').classList.remove('hidden');
                    document.getElementById('auth-bar').classList.remove('visible');
                }
            });
        }

        async function loadProfile(token) {
            try {
                const res = await fetch('/api/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    currentProfile = await res.json();
                }
            } catch (err) {
                console.error('プロフィール取得エラー:', err);
            }
        }

        function onAuthReady() {
            document.getElementById('login-overlay').classList.add('hidden');
            updateAuthUI();
            updatePlanGating();
        }

        function updateAuthUI() {
            if (!currentProfile) return;

            const bar = document.getElementById('auth-bar');
            bar.classList.add('visible');

            const avatar = document.getElementById('auth-avatar');
            if (currentProfile.avatarUrl) {
                avatar.src = currentProfile.avatarUrl;
            } else {
                avatar.style.display = 'none';
            }

            document.getElementById('auth-name').textContent = currentProfile.displayName || currentProfile.email;

            const badge = document.getElementById('auth-plan-badge');
            badge.textContent = currentProfile.plan.toUpperCase();
            badge.className = 'auth-plan-badge ' + currentProfile.plan;

            // 利用状況
            const usage = document.getElementById('auth-usage');
            if (currentProfile.limits.monthlyLimit) {
                usage.textContent = `${currentProfile.usageCount} / ${currentProfile.limits.monthlyLimit} 回使用`;
            } else {
                usage.textContent = '';
            }

            // ボタン表示
            const upgradeBtn = document.getElementById('auth-upgrade-btn');
            const manageBtn = document.getElementById('auth-manage-btn');
            if (currentProfile.plan === 'pro') {
                upgradeBtn.style.display = 'none';
                manageBtn.style.display = '';
            } else if (currentProfile.plan === 'plus') {
                upgradeBtn.textContent = 'Proにアップグレード';
                upgradeBtn.style.display = '';
                manageBtn.style.display = '';
            } else {
                upgradeBtn.textContent = 'アップグレード';
                upgradeBtn.style.display = '';
                manageBtn.style.display = 'none';
            }
        }

        function updatePlanGating() {
            if (!currentProfile) return;

            const plan = currentProfile.plan;
            const steps = currentProfile.limits.steps;

            // Step 2 ロック
            const step2Lock = document.getElementById('step2-lock');
            if (steps.includes(2)) {
                step2Lock.classList.remove('visible');
            } else {
                step2Lock.classList.add('visible');
            }

            // Step 3 ロック
            const step3Lock = document.getElementById('step3-lock');
            if (steps.includes(3)) {
                step3Lock.classList.remove('visible');
            } else {
                step3Lock.classList.add('visible');
            }
        }

        // ==================== 認証アクション ====================

        async function loginWithGoogle() {
            if (!supabaseClient) return;
            const { error } = await supabaseClient.auth.signInWithOAuth({
                provider: 'google',
                options: { redirectTo: window.location.origin }
            });
            if (error) {
                console.error('ログインエラー:', error);
                showToast('ログインに失敗しました');
            }
        }

        async function logout() {
            if (!supabaseClient) return;
            await supabaseClient.auth.signOut();
            currentUser = null;
            currentProfile = null;
            document.getElementById('auth-bar').classList.remove('visible');
            document.getElementById('login-overlay').classList.remove('hidden');
        }

        // ==================== authFetch ====================

        async function authFetch(url, options = {}) {
            if (!supabaseClient) {
                // Supabase未設定 → 通常のfetch（開発用）
                return fetch(url, options);
            }

            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                document.getElementById('login-overlay').classList.remove('hidden');
                throw new Error('ログインが必要です');
            }

            const headers = { ...options.headers, 'Authorization': `Bearer ${session.access_token}` };
            return fetch(url, { ...options, headers });
        }

        // ==================== 料金モーダル ====================

        function openPricing() {
            renderPricingCards();
            document.getElementById('pricing-overlay').classList.add('visible');
        }

        function closePricing() {
            document.getElementById('pricing-overlay').classList.remove('visible');
        }

        function toggleBilling() {
            billingYearly = !billingYearly;
            const toggle = document.getElementById('billing-toggle');
            toggle.classList.toggle('yearly', billingYearly);
            document.getElementById('billing-monthly-label').classList.toggle('active', !billingYearly);
            document.getElementById('billing-yearly-label').classList.toggle('active', billingYearly);
            renderPricingCards();
        }

        function renderPricingCards() {
            const currentPlan = currentProfile ? currentProfile.plan : 'free';
            const container = document.getElementById('pricing-cards');

            const plans = [
                {
                    id: 'free',
                    name: 'Free',
                    monthlyPrice: 0,
                    yearlyPrice: 0,
                    features: ['Step 1（SRT変換）', '話者2人まで', '月3回まで']
                },
                {
                    id: 'plus',
                    name: 'Plus',
                    monthlyPrice: 480,
                    yearlyPrice: 4800,
                    priceId: billingYearly ? window.__STRIPE_PLUS_YEARLY__ : window.__STRIPE_PLUS_MONTHLY__,
                    features: ['Step 1 + Step 2', '話者数無制限', '月10回まで']
                },
                {
                    id: 'pro',
                    name: 'Pro',
                    monthlyPrice: 980,
                    yearlyPrice: 9800,
                    priceId: billingYearly ? window.__STRIPE_PRO_YEARLY__ : window.__STRIPE_PRO_MONTHLY__,
                    features: ['全Step利用可', '話者数無制限', '回数無制限']
                }
            ];

            container.innerHTML = plans.map(plan => {
                const price = billingYearly ? plan.yearlyPrice : plan.monthlyPrice;
                const period = billingYearly ? '年' : '月';
                const isCurrent = plan.id === currentPlan;
                const isDowngrade = (currentPlan === 'pro' && plan.id !== 'pro') || (currentPlan === 'plus' && plan.id === 'free');

                let btnHtml;
                if (isCurrent) {
                    btnHtml = `<button class="pricing-card-btn current">現在のプラン</button>`;
                } else if (plan.id === 'free') {
                    btnHtml = `<button class="pricing-card-btn current" disabled>-</button>`;
                } else if (isDowngrade) {
                    btnHtml = `<button class="pricing-card-btn current" disabled>-</button>`;
                } else {
                    btnHtml = `<button class="pricing-card-btn upgrade" onclick="startCheckout('${plan.priceId}')">アップグレード</button>`;
                }

                return `
                    <div class="pricing-card ${isCurrent ? 'current' : ''}">
                        <div class="pricing-card-name">${plan.name}</div>
                        <div class="pricing-card-price">${price === 0 ? '無料' : '¥' + price.toLocaleString()}<span>${price > 0 ? ' / ' + period : ''}</span></div>
                        <div class="pricing-card-billing">${billingYearly && price > 0 ? '¥' + Math.round(plan.yearlyPrice / 12).toLocaleString() + '/月 相当' : ''}</div>
                        <ul class="pricing-card-features">
                            ${plan.features.map(f => `<li>${f}</li>`).join('')}
                        </ul>
                        ${btnHtml}
                    </div>
                `;
            }).join('');
        }

        async function startCheckout(priceId) {
            if (!priceId) {
                showToast('価格設定がまだ完了していません');
                return;
            }

            try {
                const res = await authFetch('/api/stripe/checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ priceId })
                });

                const data = await res.json();
                if (!res.ok) throw new Error(data.error);

                window.location.href = data.url;
            } catch (err) {
                showToast('チェックアウトの開始に失敗しました');
                console.error(err);
            }
        }

        async function openPortal() {
            try {
                const res = await authFetch('/api/stripe/portal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await res.json();
                if (!res.ok) throw new Error(data.error);

                window.location.href = data.url;
            } catch (err) {
                showToast('契約管理ページを開けませんでした');
                console.error(err);
            }
        }

        // 料金モーダル外クリックで閉じる
        document.getElementById('pricing-overlay').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closePricing();
        });

        // ==================== 準備ガイド ====================

        function selectPrepType(type) {
            prepType = type;

            // カード選択表示
            document.querySelectorAll('.prep-card').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');

            // 選択画面を非表示、選択済みバーを表示
            setTimeout(() => {
                document.getElementById('prep-selection').style.display = 'none';
                const bar = document.getElementById('prep-selected-bar');
                const labels = { mp4: 'MP4動画ファイル', mp3: 'MP3音声ファイル', text: '文字起こしテキスト' };
                document.getElementById('prep-selected-label').textContent = '選択: ' + labels[type];
                bar.classList.add('visible');

                // 該当セクション表示
                if (type === 'mp4') {
                    document.getElementById('prep1-section').classList.add('visible');
                    document.getElementById('prep2-section').classList.remove('visible');
                } else if (type === 'mp3') {
                    document.getElementById('prep1-section').classList.remove('visible');
                    document.getElementById('prep2-section').classList.add('visible');
                } else {
                    // text: 準備不要、Step1にフォーカス
                    document.getElementById('prep1-section').classList.remove('visible');
                    document.getElementById('prep2-section').classList.remove('visible');
                    document.getElementById('step1-input').focus();
                    document.getElementById('step1-section').scrollIntoView({ behavior: 'smooth' });
                }
            }, 150);
        }

        function resetPrepSelection() {
            prepType = null;
            document.getElementById('prep-selection').style.display = '';
            document.getElementById('prep-selected-bar').classList.remove('visible');
            document.getElementById('prep1-section').classList.remove('visible');
            document.getElementById('prep2-section').classList.remove('visible');

            // カード選択リセット
            document.querySelectorAll('.prep-card').forEach(c => c.classList.remove('selected'));

            // サブステップリセット
            resetSubsteps('prep1');
            resetSubsteps('prep2');

            document.getElementById('prep-selection').scrollIntoView({ behavior: 'smooth' });
        }

        // サブステップナビゲーション
        function nextSubstep(prep, toIndex) {
            showSubstep(prep, toIndex);
        }

        function prevSubstep(prep, toIndex) {
            showSubstep(prep, toIndex);
        }

        function showSubstep(prep, index) {
            const section = document.getElementById(`${prep}-section`);
            const substeps = section.querySelectorAll('.substep');
            substeps.forEach(s => s.classList.remove('active'));
            substeps[index].classList.add('active');

            // インジケーター更新
            const dots = document.getElementById(`${prep}-indicator`).querySelectorAll('.substep-dot');
            dots.forEach((d, i) => {
                d.classList.remove('active', 'done');
                if (i < index) d.classList.add('done');
                if (i === index) d.classList.add('active');
            });

            section.scrollIntoView({ behavior: 'smooth' });
        }

        function resetSubsteps(prep) {
            const section = document.getElementById(`${prep}-section`);
            const substeps = section.querySelectorAll('.substep');
            substeps.forEach((s, i) => {
                s.classList.toggle('active', i === 0);
            });
            const dots = document.getElementById(`${prep}-indicator`).querySelectorAll('.substep-dot');
            dots.forEach((d, i) => {
                d.classList.remove('done');
                d.classList.toggle('active', i === 0);
            });
        }

        function completePrepStep(prep) {
            if (prep === 'prep1') {
                // 準備1完了 → 準備2を表示
                document.getElementById('prep1-section').classList.remove('visible');
                document.getElementById('prep2-section').classList.add('visible');
                document.getElementById('prep2-section').scrollIntoView({ behavior: 'smooth' });
            } else if (prep === 'prep2') {
                // 準備2完了 → Step1にフォーカス
                document.getElementById('prep2-section').classList.remove('visible');
                document.getElementById('step1-input').focus();
                document.getElementById('step1-section').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // OS切替
        function switchOS(tabEl, os, groupId) {
            // タブ切替
            const tabs = tabEl.parentElement;
            tabs.querySelectorAll('.os-tab').forEach(t => t.classList.remove('active'));
            tabEl.classList.add('active');

            // コンテンツ切替
            document.getElementById(`${groupId}-mac`).classList.toggle('active', os === 'mac');
            document.getElementById(`${groupId}-win`).classList.toggle('active', os === 'win');
        }

        // コマンドコピー
        function copyCmd(blockId) {
            const block = document.getElementById(blockId);
            // ボタンテキストを除いたコマンド部分を取得
            const text = block.childNodes[0].textContent.trim();
            navigator.clipboard.writeText(text).then(() => {
                showToast('コピーしました');
            });
        }

        // 話者フォーム
        function addSpeakerRow() {
            const form = document.getElementById('speaker-form');
            const row = document.createElement('div');
            row.className = 'speaker-row';
            row.innerHTML = `
                <input type="text" placeholder="話者名（例: 鈴木太郎）" class="speaker-name-input">
                <select class="speaker-gender-select">
                    <option value="男性">男性</option>
                    <option value="女性">女性</option>
                    <option value="不特定">不特定</option>
                </select>
                <button class="speaker-remove-btn" onclick="removeSpeakerRow(this)" title="削除">&times;</button>
            `;
            form.appendChild(row);
        }

        function removeSpeakerRow(btn) {
            const form = document.getElementById('speaker-form');
            if (form.querySelectorAll('.speaker-row').length > 1) {
                btn.closest('.speaker-row').remove();
            } else {
                showToast('話者は最低1人必要です');
            }
        }

        // プロンプト生成
        function generatePrompt() {
            const rows = document.querySelectorAll('#speaker-form .speaker-row');
            const speakers = [];
            rows.forEach(row => {
                const name = row.querySelector('.speaker-name-input').value.trim();
                const gender = row.querySelector('.speaker-gender-select').value;
                if (name) {
                    speakers.push({ name, gender });
                }
            });

            if (speakers.length === 0) {
                showToast('話者名を1人以上入力してください');
                return;
            }

            const contentDesc = document.getElementById('content-desc').value.trim();

            let prompt = `以下の音声ファイルを文字起こししてください。

## 出力形式
各発言を以下の形式で出力してください：
話者名（性別）: [分:秒] 発言内容

## 既知の話者
${speakers.map(s => `- ${s.name}（${s.gender}）`).join('\n')}`;

            if (contentDesc) {
                prompt += `\n\n## 内容\n${contentDesc}`;
            }

            prompt += `

## ルール
- タイムスタンプは [M:SS] 形式（例: [0:00], [1:30], [12:05]）
- 句読点を適切に使用してください
- 上記以外の話者が登場した場合は「話者A（不特定）」「話者B（不特定）」のように命名してください
- 話者の区別が難しい場合も最善の推測で分離してください
- 相槌や短い反応も省略せず記載してください`;

            document.getElementById('prompt-output').value = prompt;
            document.getElementById('generated-prompt').classList.add('visible');
        }

        // ==================== Step 1 ====================
        async function runStep1() {
            const input = document.getElementById('step1-input').value;
            if (!input.trim()) {
                showError('step1-error', 'テキストを入力してください');
                return;
            }

            showLoading('step1');
            hideError('step1-error');
            hideResult('step1-result');
            hideNext('step1-next');

            try {
                const res = await authFetch('/api/step1/convert', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: input })
                });

                const data = await res.json();
                if (res.status === 403 && data.requiredPlan) {
                    openPricing();
                    throw new Error(data.error);
                }
                if (res.status === 429) {
                    openPricing();
                    throw new Error(data.error);
                }
                if (!res.ok) throw new Error(data.error || '変換に失敗しました');

                document.getElementById('step1-output').value = data.srt;
                document.getElementById('step1-stats').innerHTML =
                    `<div class="stat-item"><span class="stat-label">字幕数:</span><span class="stat-value">${data.subtitleCount}</span></div>` +
                    `<div class="stat-item"><span class="stat-label">話者:</span><span class="stat-value">${data.speakers.join(', ')}</span></div>`;

                showResult('step1-result');
                showNext('step1-next');
            } catch (err) {
                showError('step1-error', err.message);
            } finally {
                hideLoading('step1');
            }
        }

        function goToStep2() {
            const srt = document.getElementById('step1-output').value;
            document.getElementById('step2-input').value = srt;
            document.getElementById('step2-section').scrollIntoView({ behavior: 'smooth' });
        }

        // ==================== Step 2 ====================
        async function runStep2() {
            const input = document.getElementById('step2-input').value;
            if (!input.trim()) {
                showError('step2-error', 'SRTテキストを入力してください');
                return;
            }

            showLoading('step2');
            hideError('step2-error');
            hideResult('step2-result');
            hideNext('step2-next');

            try {
                const res = await authFetch('/api/step2/edit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ srt: input })
                });

                const data = await res.json();
                if (res.status === 403 && data.requiredPlan) {
                    openPricing();
                    throw new Error(data.error);
                }
                if (res.status === 429) {
                    openPricing();
                    throw new Error(data.error);
                }
                if (!res.ok) throw new Error(data.error || '編集に失敗しました');

                document.getElementById('step2-output').value = data.srt;

                const ops = data.operations;
                document.getElementById('step2-stats').innerHTML =
                    `<div class="stat-item"><span class="stat-label">処理前:</span><span class="stat-value">${data.originalCount}個</span></div>` +
                    `<div class="stat-item"><span class="stat-label">処理後:</span><span class="stat-value">${data.editedCount}個</span></div>` +
                    `<div class="stat-item"><span class="stat-label">削除:</span><span class="stat-value">${ops.deleted}</span></div>` +
                    `<div class="stat-item"><span class="stat-label">結合:</span><span class="stat-value">${ops.merged}</span></div>` +
                    `<div class="stat-item"><span class="stat-label">分割:</span><span class="stat-value">${ops.split}</span></div>`;

                showResult('step2-result');
                showNext('step2-next');
            } catch (err) {
                showError('step2-error', err.message);
            } finally {
                hideLoading('step2');
            }
        }

        function goToStep3() {
            const srt = document.getElementById('step2-output').value;
            document.getElementById('step3-input').value = srt;
            document.getElementById('step3-section').scrollIntoView({ behavior: 'smooth' });
        }

        // ==================== Step 3 ====================
        async function runStep3() {
            const input = document.getElementById('step3-input').value;
            if (!input.trim()) {
                showError('step3-error', 'SRTテキストを入力してください');
                return;
            }

            showLoading('step3');
            hideError('step3-error');
            hideResult('step3-result');

            try {
                const res = await authFetch('/api/step3/split', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ srt: input })
                });

                const data = await res.json();
                if (res.status === 403 && data.requiredPlan) {
                    openPricing();
                    throw new Error(data.error);
                }
                if (res.status === 429) {
                    openPricing();
                    throw new Error(data.error);
                }
                if (!res.ok) throw new Error(data.error || '分割に失敗しました');

                speakerData = data.speakers;
                const speakers = Object.keys(speakerData);

                if (speakers.length === 0) {
                    throw new Error('話者が見つかりませんでした');
                }

                // 統計
                let totalCount = 0;
                const speakerStats = speakers.map(s => {
                    totalCount += speakerData[s].count;
                    return `${s}: ${speakerData[s].count}個`;
                });

                document.getElementById('step3-stats').innerHTML =
                    `<div class="stat-item"><span class="stat-label">話者数:</span><span class="stat-value">${speakers.length}</span></div>` +
                    `<div class="stat-item"><span class="stat-label">合計字幕:</span><span class="stat-value">${totalCount}個</span></div>` +
                    `<div class="stat-item"><span class="stat-label">内訳:</span><span class="stat-value">${speakerStats.join(' / ')}</span></div>`;

                // タブ生成
                const tabsEl = document.getElementById('speaker-tabs');
                const contentEl = document.getElementById('speaker-content');
                tabsEl.innerHTML = '';
                contentEl.innerHTML = '';

                speakers.forEach((speaker, idx) => {
                    // タブ
                    const tab = document.createElement('div');
                    tab.className = 'speaker-tab' + (idx === 0 ? ' active' : '');
                    tab.innerHTML = `${speaker}<span class="count-badge">${speakerData[speaker].count}</span>`;
                    tab.onclick = () => switchSpeaker(speaker);
                    tabsEl.appendChild(tab);

                    // コンテンツ
                    const div = document.createElement('div');
                    div.className = 'speaker-srt' + (idx === 0 ? ' active' : '');
                    div.id = `speaker-${speaker}`;
                    div.innerHTML =
                        `<textarea rows="10" readonly style="width:100%;font-family:'Courier New',Consolas,monospace;font-size:13px;border:none;resize:vertical;">${escapeHtml(speakerData[speaker].srt)}</textarea>` +
                        `<div class="btn-group"><button class="btn btn-secondary" onclick="downloadSpeaker('${escapeAttr(speaker)}')">ダウンロード: 字幕_${escapeHtml(speaker)}.srt</button><button class="btn btn-secondary" onclick="copySpeakerSrt('${escapeAttr(speaker)}')">コピー</button></div>`;
                    contentEl.appendChild(div);
                });

                showResult('step3-result');
                showNext('step3-next');
            } catch (err) {
                showError('step3-error', err.message);
            } finally {
                hideLoading('step3');
            }
        }

        function goToPremiere() {
            document.getElementById('premiere-section').scrollIntoView({ behavior: 'smooth' });
        }

        function switchSpeaker(speaker) {
            document.querySelectorAll('.speaker-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.speaker-srt').forEach(s => s.classList.remove('active'));

            // タブをアクティブに
            const tabs = document.querySelectorAll('.speaker-tab');
            tabs.forEach(t => {
                if (t.textContent.startsWith(speaker)) t.classList.add('active');
            });

            const el = document.getElementById(`speaker-${speaker}`);
            if (el) el.classList.add('active');
        }

        function downloadSpeaker(speaker) {
            if (speakerData[speaker]) {
                downloadBlob(speakerData[speaker].srt, `字幕_${speaker}.srt`);
            }
        }

        function copySpeakerSrt(speaker) {
            if (speakerData[speaker]) {
                navigator.clipboard.writeText(speakerData[speaker].srt).then(() => {
                    showToast('コピーしました');
                });
            }
        }

        function downloadAllSpeakers() {
            for (const [speaker, data] of Object.entries(speakerData)) {
                downloadBlob(data.srt, `字幕_${speaker}.srt`);
            }
        }

        // ==================== ユーティリティ ====================

        function showLoading(step) {
            document.getElementById(`${step}-loading`).classList.add('visible');
            document.getElementById(`${step}-btn`).disabled = true;
        }

        function hideLoading(step) {
            document.getElementById(`${step}-loading`).classList.remove('visible');
            document.getElementById(`${step}-btn`).disabled = false;
        }

        function showError(id, msg) {
            const el = document.getElementById(id);
            el.textContent = msg;
            el.classList.add('visible');
        }

        function hideError(id) {
            document.getElementById(id).classList.remove('visible');
        }

        function showResult(id) {
            document.getElementById(id).classList.add('visible');
        }

        function hideResult(id) {
            document.getElementById(id).classList.remove('visible');
        }

        function showNext(id) {
            document.getElementById(id).classList.add('visible');
        }

        function hideNext(id) {
            document.getElementById(id).classList.remove('visible');
        }

        function downloadText(textareaId, filename) {
            const text = document.getElementById(textareaId).value;
            downloadBlob(text, filename);
        }

        function downloadBlob(text, filename) {
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function copyText(textareaId) {
            const text = document.getElementById(textareaId).value;
            navigator.clipboard.writeText(text).then(() => {
                showToast('コピーしました');
            });
        }

        function showToast(msg) {
            const toast = document.createElement('div');
            toast.textContent = msg;
            toast.style.cssText = 'position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px 24px;border-radius:8px;font-size:0.9em;z-index:9999;opacity:0;transition:opacity 0.3s;';
            document.body.appendChild(toast);
            requestAnimationFrame(() => { toast.style.opacity = '1'; });
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 1500);
        }

        function escapeHtml(str) {
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function escapeAttr(str) {
            return str.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        }

        // ==================== ソースコード保護（簡易） ====================
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('keydown', e => {
            if (e.ctrlKey && (e.key === 's' || e.key === 'u' || e.key === 'S' || e.key === 'U')) {
                e.preventDefault();
            }
            if (e.key === 'F12') {
                e.preventDefault();
            }
            if (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'i' || e.key === 'J' || e.key === 'j')) {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>
