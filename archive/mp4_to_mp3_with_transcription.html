<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MP4â†’MP3å¤‰æ› + æ–‡å­—èµ·ã“ã—ãƒ„ãƒ¼ãƒ«</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .upload-area.dragover {
            border-color: #667eea;
            background: #e8f0fe;
        }
        
        .file-input {
            display: none;
        }
        
        .file-info {
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
            display: none;
        }
        
        .settings {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .setting-group {
            margin: 15px 0;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        select, input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        textarea {
            resize: vertical;
            height: 100px;
        }
        
        .action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin: 20px 0;
            transition: transform 0.2s;
        }
        
        .action-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        
        .action-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .transcribe-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .progress {
            margin: 20px 0;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            width: 0%;
        }
        
        .result {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .transcription-result {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            color: #0d47a1;
        }
        
        .download-btn {
            background: #28a745;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 5px;
            display: inline-block;
            margin: 10px 5px 0 0;
        }
        
        .copy-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px 0 0;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .stat-item {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }
        
        .transcription-text {
            background: white;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
            margin: 10px 0;
            white-space: pre-wrap;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .compress-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .compress-dialog.show {
            display: flex;
        }
        
        .compress-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            margin: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .file-size-warning {
            color: #f39c12;
            font-size: 1.2em;
            margin: 15px 0;
        }
        
        .dialog-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .dialog-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .dialog-btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-compress {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }
        
        .btn-cancel {
            background: #6c757d;
            color: white;
        }
        
        .compression-info {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #28a745;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ MP4â†’MP3å¤‰æ› + ğŸ“ æ–‡å­—èµ·ã“ã—ãƒ„ãƒ¼ãƒ«</h1>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('convert')">ğŸ”„ MP4â†’MP3å¤‰æ›</div>
            <div class="tab" onclick="switchTab('transcribe')">ğŸ“ æ–‡å­—èµ·ã“ã—</div>
        </div>
        
        <!-- MP4â†’MP3å¤‰æ›ã‚¿ãƒ– -->
        <div id="convert-tab" class="tab-content active">
            <div class="upload-area" id="convertUploadArea">
                <div>
                    <h3>ğŸ“ MP4ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</h3>
                    <p>ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã™ã‚‹ã‹ã€ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ãã ã•ã„</p>
                </div>
            </div>
            
            <input type="file" id="convertFileInput" class="file-input" accept=".mp4,video/mp4" multiple>
            
            <div class="file-info" id="convertFileInfo">
                <h4>é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:</h4>
                <div id="convertFileList"></div>
            </div>
            
            <div class="settings">
                <div class="setting-group">
                    <label for="convertQuality">éŸ³è³ªè¨­å®š:</label>
                    <select id="convertQuality">
                        <option value="128">128 kbps (æ¨™æº–)</option>
                        <option value="192" selected>192 kbps (é«˜å“è³ª)</option>
                        <option value="256">256 kbps (æœ€é«˜å“è³ª)</option>
                        <option value="320">320 kbps (ãƒ—ãƒ¬ãƒŸã‚¢ãƒ )</option>
                    </select>
                </div>
            </div>
            
            <button class="action-btn" id="convertBtn" onclick="convertFiles()" disabled>
                ğŸ”„ MP3ã«å¤‰æ›
            </button>
        </div>
        
        <!-- æ–‡å­—èµ·ã“ã—ã‚¿ãƒ– -->
        <div id="transcribe-tab" class="tab-content">
            <div class="upload-area" id="transcribeUploadArea">
                <div>
                    <h3>ğŸ¤ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</h3>
                    <p>MP3, MP4, WAV, M4A ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œï¼ˆæœ€å¤§25MBï¼‰</p>
                </div>
            </div>
            
            <input type="file" id="transcribeFileInput" class="file-input" 
                   accept=".mp3,.mp4,.wav,.m4a,.webm,audio/*,video/mp4">
            
            <div class="file-info" id="transcribeFileInfo">
                <h4>é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:</h4>
                <div id="transcribeFileList"></div>
            </div>
            
            <div class="settings">
                <div class="setting-group">
                    <label for="language">è¨€èªè¨­å®š:</label>
                    <select id="language">
                        <option value="ja" selected>æ—¥æœ¬èª</option>
                        <option value="en">è‹±èª</option>
                        <option value="auto">è‡ªå‹•æ¤œå‡º</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label for="prompt">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆç²¾åº¦å‘ä¸Šç”¨ï¼‰:</label>
                    <textarea id="prompt" placeholder="å°‚é–€ç”¨èªã‚„å›ºæœ‰åè©ã‚’ã“ã“ã«å…¥åŠ›ã™ã‚‹ã¨èªè­˜ç²¾åº¦ãŒå‘ä¸Šã—ã¾ã™ï¼ˆä»»æ„ï¼‰"></textarea>
                </div>
            </div>
            
            <button class="action-btn transcribe-btn" id="transcribeBtn" onclick="transcribeAudio()" disabled>
                ğŸ“ æ–‡å­—èµ·ã“ã—å®Ÿè¡Œ
            </button>
        </div>
        
        <div class="progress" id="progress">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">å‡¦ç†ä¸­...</p>
        </div>
        
        <div class="result" id="result"></div>
    </div>

    <!-- åœ§ç¸®ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
    <div class="compress-dialog" id="compressDialog">
        <div class="compress-content">
            <h3>âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™</h3>
            <div class="file-size-warning" id="fileSizeInfo">
                ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: <span id="currentFileSize">0</span>MB
            </div>
            <div class="compression-info">
                <p><strong>ğŸ“¦ è‡ªå‹•åœ§ç¸®ã‚’å®Ÿè¡Œã—ã¾ã™</strong></p>
                <p>â€¢ ç”»è³ªã‚’èª¿æ•´ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’å‰Šæ¸›</p>
                <p>â€¢ éŸ³å£°å“è³ªã¯ä¿æŒã—ã¾ã™</p>
                <p>â€¢ å‡¦ç†æ™‚é–“: ç´„<span id="estimatedTime">2-3</span>åˆ†</p>
            </div>
            <div class="dialog-buttons">
                <button class="dialog-btn btn-compress" onclick="startCompression()">
                    ğŸ—œï¸ åœ§ç¸®ã—ã¦ç¶šè¡Œ
                </button>
                <button class="dialog-btn btn-cancel" onclick="cancelCompression()">
                    âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js"></script>
    <script>
        // FFmpegã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’å®‰å…¨ã«å–å¾—
        let FFmpeg, fetchFile;
        try {
            FFmpeg = window.FFmpegWASM?.FFmpeg;
            fetchFile = window.FFmpegUtil?.fetchFile;
            
            if (!FFmpeg || !fetchFile) {
                console.warn('âš ï¸ FFmpeg/fetchFileãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å¤‰æ›æ©Ÿèƒ½ãŒåˆ¶é™ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
            } else {
                console.log('âœ… FFmpegæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
            }
        } catch (error) {
            console.error('âŒ FFmpegèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        }
        
        let ffmpeg = null;
        let selectedConvertFiles = [];
        let selectedTranscribeFile = null;
        
        // DOMãŒèª­ã¿è¾¼ã¾ã‚ŒãŸå¾Œã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ DOMèª­ã¿è¾¼ã¿å®Œäº†ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šä¸­...');
            
            // ç›´ã¡ã«åˆæœŸåŒ–ã‚’å®Ÿè¡Œ
            try {
                initializeEventListeners();
                preventDefaultDragBehavior();
                console.log('âœ… åˆæœŸåŒ–å®Œäº†');
            } catch (error) {
                console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                
                // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯å°‘ã—å¾…ã£ã¦ã‚‚ã†ä¸€åº¦è©¦ã™
                setTimeout(() => {
                    console.log('ğŸ”„ åˆæœŸåŒ–ã‚’å†è©¦è¡Œä¸­...');
                    try {
                        initializeEventListeners();
                        preventDefaultDragBehavior();
                        console.log('âœ… å†è©¦è¡Œã§åˆæœŸåŒ–å®Œäº†');
                    } catch (retryError) {
                        console.error('âŒ å†è©¦è¡Œã§ã‚‚åˆæœŸåŒ–å¤±æ•—:', retryError);
                    }
                }, 500);
            }
        });
        
        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ã—ã¦ã€window.onloadã§ã‚‚è©¦ã™
        window.addEventListener('load', function() {
            console.log('ğŸ”„ window.load - ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—åˆæœŸåŒ–ç¢ºèªä¸­...');
            
            // è¦ç´ ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const convertArea = document.getElementById('convertUploadArea');
            const transcribeArea = document.getElementById('transcribeUploadArea');
            
            if (convertArea && transcribeArea) {
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒæ—¢ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const hasListeners = convertArea.onclick !== null;
                
                if (!hasListeners) {
                    console.log('ğŸš¨ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ - å¼·åˆ¶å†è¨­å®šä¸­...');
                    try {
                        initializeEventListeners();
                        preventDefaultDragBehavior();
                        console.log('âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—åˆæœŸåŒ–å®Œäº†');
                    } catch (error) {
                        console.error('âŒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—åˆæœŸåŒ–å¤±æ•—:', error);
                    }
                } else {
                    console.log('âœ… ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¯æ—¢ã«è¨­å®šæ¸ˆã¿');
                }
            } else {
                console.error('âŒ å¿…è¦ãªè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        });
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å‹•ä½œã‚’ç„¡åŠ¹åŒ–
        function preventDefaultDragBehavior() {
            console.log('ğŸ›¡ï¸ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å‹•ä½œã‚’ç„¡åŠ¹åŒ–ä¸­...');
            
            // ãƒšãƒ¼ã‚¸å…¨ä½“ã§ã®ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚’ç„¡åŠ¹åŒ–ï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢å¤–ã®ã¿ï¼‰
            document.addEventListener('dragover', function(e) {
                if (!e.target.closest('.upload-area')) {
                    e.preventDefault();
                }
            });
            
            document.addEventListener('drop', function(e) {
                // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢å†…ã§ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã‚’ç„¡åŠ¹åŒ–
                if (!e.target.closest('.upload-area')) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('ğŸš« ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢å¤–ã§ã®ãƒ‰ãƒ­ãƒƒãƒ—ã‚’ç„¡åŠ¹åŒ–');
                    return false;
                }
            });
            
            console.log('âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ç„¡åŠ¹åŒ–å®Œäº†');
        }
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tabName) {
            console.log('ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ:', tabName);
            // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®åˆæœŸåŒ–
        function initializeEventListeners() {
            console.log('ğŸ”— ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼åˆæœŸåŒ–é–‹å§‹...');
            
            // è¦ç´ ã®å­˜åœ¨ç¢ºèª
            const convertFileInput = document.getElementById('convertFileInput');
            const transcribeFileInput = document.getElementById('transcribeFileInput');
            const convertUploadArea = document.getElementById('convertUploadArea');
            const transcribeUploadArea = document.getElementById('transcribeUploadArea');
            
            console.log('è¦ç´ å­˜åœ¨ç¢ºèª:');
            console.log('  convertFileInput:', !!convertFileInput);
            console.log('  transcribeFileInput:', !!transcribeFileInput);
            console.log('  convertUploadArea:', !!convertUploadArea);
            console.log('  transcribeUploadArea:', !!transcribeUploadArea);
            
            // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            if (convertFileInput) {
                convertFileInput.addEventListener('change', handleConvertFiles);
                console.log('âœ… MP4å¤‰æ›ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†');
            } else {
                console.error('âŒ convertFileInputè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
            
            if (transcribeFileInput) {
                transcribeFileInput.addEventListener('change', handleTranscribeFile);
                console.log('âœ… æ–‡å­—èµ·ã“ã—ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†');
            } else {
                console.error('âŒ transcribeFileInputè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
            
            // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            if (convertUploadArea) {
                console.log('ğŸ”— convertUploadAreaã«ã‚¯ãƒªãƒƒã‚¯ãƒªã‚¹ãƒŠãƒ¼è¨­å®šä¸­...');
                
                const clickHandler = function(e) {
                    console.log('ğŸ–±ï¸ MP4å¤‰æ›ã‚¨ãƒªã‚¢ã‚¯ãƒªãƒƒã‚¯æ¤œå‡ºï¼', e);
                    const fileInput = document.getElementById('convertFileInput');
                    if (fileInput) {
                        fileInput.click();
                        console.log('âœ… ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ã‚¯ãƒªãƒƒã‚¯');
                    } else {
                        console.error('âŒ ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }
                };
                
                convertUploadArea.addEventListener('click', clickHandler);
                console.log('âœ… MP4å¤‰æ›ã‚¨ãƒªã‚¢ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šå®Œäº†');
                
                // è¨­å®šç¢ºèª
                setTimeout(() => {
                    const testEvent = new MouseEvent('click', { bubbles: true });
                    console.log('ğŸ§ª ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ...');
                    convertUploadArea.dispatchEvent(testEvent);
                }, 100);
                
            } else {
                console.error('âŒ convertUploadAreaè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
            
            if (transcribeUploadArea) {
                console.log('ğŸ”— transcribeUploadAreaã«ã‚¯ãƒªãƒƒã‚¯ãƒªã‚¹ãƒŠãƒ¼è¨­å®šä¸­...');
                
                const transcribeClickHandler = function(e) {
                    console.log('ğŸ–±ï¸ æ–‡å­—èµ·ã“ã—ã‚¨ãƒªã‚¢ã‚¯ãƒªãƒƒã‚¯æ¤œå‡ºï¼', e);
                    const fileInput = document.getElementById('transcribeFileInput');
                    if (fileInput) {
                        fileInput.click();
                        console.log('âœ… æ–‡å­—èµ·ã“ã—ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ã‚¯ãƒªãƒƒã‚¯');
                    } else {
                        console.error('âŒ æ–‡å­—èµ·ã“ã—ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }
                };
                
                transcribeUploadArea.addEventListener('click', transcribeClickHandler);
                console.log('âœ… æ–‡å­—èµ·ã“ã—ã‚¨ãƒªã‚¢ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šå®Œäº†');
                
            } else {
                console.error('âŒ transcribeUploadAreaè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
            
            // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            console.log('ğŸ¯ ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®šé–‹å§‹...');
            setupDragAndDrop();
            
            console.log('ğŸ‰ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼åˆæœŸåŒ–å®Œäº†ï¼');
        }
        
        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã®è¨­å®š
        function setupDragAndDrop() {
            const uploadAreas = document.querySelectorAll('.upload-area');
            console.log(`ğŸ“ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢æ•°: ${uploadAreas.length}`);
            
            uploadAreas.forEach((area, index) => {
                console.log(`ğŸ¯ ã‚¨ãƒªã‚¢${index}ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®šä¸­...`);
                
                area.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    area.classList.add('dragover');
                    console.log(`ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼: ã‚¨ãƒªã‚¢${index}`);
                });
                
                area.addEventListener('dragleave', (e) => {
                    // å­è¦ç´ ã¸ã®ç§»å‹•ã¯ç„¡è¦–
                    if (!area.contains(e.relatedTarget)) {
                        area.classList.remove('dragover');
                        console.log(`ãƒ‰ãƒ©ãƒƒã‚°ãƒªãƒ¼ãƒ–: ã‚¨ãƒªã‚¢${index}`);
                    }
                });
                
                area.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    area.classList.remove('dragover');
                    
                    console.log(`ğŸ¯ğŸ¯ğŸ¯ ãƒ‰ãƒ­ãƒƒãƒ—æ¤œå‡ºæˆåŠŸ: ã‚¨ãƒªã‚¢${index}`);
                    
                    const files = Array.from(e.dataTransfer.files);
                    console.log(`ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${files.length}`);
                    files.forEach(file => console.log(`   - ${file.name}, ã‚¿ã‚¤ãƒ—: ${file.type}, ã‚µã‚¤ã‚º: ${(file.size/1024/1024).toFixed(1)}MB`));
                    
                    if (index === 0) {
                        // MP4â†’MP3å¤‰æ›ç”¨
                        console.log('ğŸ”„ MP4â†’MP3å¤‰æ›ã‚¨ãƒªã‚¢ã§å‡¦ç†');
                        const mp4Files = files.filter(file => 
                            file.type === 'video/mp4' || file.name.toLowerCase().endsWith('.mp4')
                        );
                        console.log(`ğŸ“¹ MP4ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${mp4Files.length}`);
                        if (mp4Files.length > 0) {
                            console.log('âœ… MP4å¤‰æ›å‡¦ç†é–‹å§‹');
                            handleConvertFileSelection(mp4Files);
                        } else {
                            alert('MP4ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„');
                        }
                    } else {
                        // æ–‡å­—èµ·ã“ã—ç”¨
                        console.log('ğŸ“ æ–‡å­—èµ·ã“ã—ã‚¨ãƒªã‚¢ã§å‡¦ç†');
                        const audioFile = files.find(file => 
                            file.type.startsWith('audio/') || 
                            file.type === 'video/mp4' ||
                            /\.(mp3|mp4|wav|m4a|webm)$/i.test(file.name)
                        );
                        if (audioFile) {
                            console.log('ğŸ¤ é©åˆ‡ãªéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:', audioFile.name);
                            console.log('âœ… æ–‡å­—èµ·ã“ã—å‡¦ç†é–‹å§‹');
                            handleTranscribeFileSelection(audioFile);
                        } else {
                            alert('éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆMP3, MP4, WAV, M4A, WebMï¼‰ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„');
                        }
                    }
                });
                
                console.log(`âœ… ã‚¨ãƒªã‚¢${index}ã®ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®šå®Œäº†`);
            });
        }
        
        // FFmpegã®åˆæœŸåŒ–
        async function initFFmpeg() {
            if (ffmpeg) return;
            
            ffmpeg = new FFmpeg();
            
            ffmpeg.on('log', ({ message }) => {
                console.log(message);
            });
            
            ffmpeg.on('progress', ({ progress }) => {
                const percent = Math.round(progress * 100);
                document.getElementById('progressFill').style.width = `${percent}%`;
                document.getElementById('progressText').textContent = `å¤‰æ›ä¸­... ${percent}%`;
            });
            
            const baseURL = 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd';
            await ffmpeg.load({
                coreURL: `${baseURL}/ffmpeg-core.js`,
                wasmURL: `${baseURL}/ffmpeg-core.wasm`,
            });
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†é–¢æ•°ç¾¤
        function handleConvertFiles(e) {
            console.log('ğŸ“ MP4å¤‰æ›ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ');
            const files = Array.from(e.target.files);
            handleConvertFileSelection(files);
        }
        
        function handleConvertFileSelection(files) {
            console.log('ğŸ“ MP4å¤‰æ›ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†:', files.length, 'å€‹');
            selectedConvertFiles = files;
            
            if (files.length > 0) {
                document.getElementById('convertFileInfo').style.display = 'block';
                const fileList = document.getElementById('convertFileList');
                fileList.innerHTML = files.map(file => 
                    `<div>ğŸ“¹ ${file.name} (${(file.size / (1024*1024)).toFixed(1)}MB)</div>`
                ).join('');
                
                document.getElementById('convertBtn').disabled = false;
                console.log('âœ… MP4å¤‰æ›ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–');
            } else {
                document.getElementById('convertFileInfo').style.display = 'none';
                document.getElementById('convertBtn').disabled = true;
                console.log('âŒ MP4å¤‰æ›ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–');
            }
        }
        
        function handleTranscribeFile(e) {
            console.log('ğŸ¤ æ–‡å­—èµ·ã“ã—ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ');
            const file = e.target.files[0];
            handleTranscribeFileSelection(file);
        }
        
        function handleTranscribeFileSelection(file) {
            console.log('ğŸ¤ æ–‡å­—èµ·ã“ã—ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†:', file ? file.name : 'null');
            selectedTranscribeFile = file;
            
            if (file) {
                document.getElementById('transcribeFileInfo').style.display = 'block';
                const fileList = document.getElementById('transcribeFileList');
                fileList.innerHTML = `<div>ğŸ¤ ${file.name} (${(file.size / (1024*1024)).toFixed(1)}MB)</div>`;
                
                document.getElementById('transcribeBtn').disabled = false;
                console.log('âœ… æ–‡å­—èµ·ã“ã—ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–');
            } else {
                document.getElementById('transcribeFileInfo').style.display = 'none';
                document.getElementById('transcribeBtn').disabled = true;
                console.log('âŒ æ–‡å­—èµ·ã“ã—ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–');
            }
        }
        
        // FileListã‚’ä½œæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function createFileList(files) {
            const dt = new DataTransfer();
            files.forEach(file => dt.items.add(file));
            return dt.files;
        }
        
        // åœ§ç¸®ãŒå¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’ä¿å­˜
        let filesNeedingCompression = [];
        let currentCompressionIndex = 0;
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ100MBä»¥ä¸Šã§åœ§ç¸®æ¨å¥¨ï¼‰
        function checkFileSizes(files) {
            const largeFiles = files.filter(file => file.size > 100 * 1024 * 1024);
            
            if (largeFiles.length > 0) {
                filesNeedingCompression = largeFiles;
                
                // ç·ã‚µã‚¤ã‚ºè¨ˆç®—
                const totalSizeMB = largeFiles.reduce((sum, file) => sum + file.size, 0) / (1024 * 1024);
                const estimatedMinutes = Math.ceil(totalSizeMB / 50); // 50MB/åˆ†ã®å‡¦ç†é€Ÿåº¦æƒ³å®š
                
                // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã«æƒ…å ±ã‚’è¨­å®š
                document.getElementById('currentFileSize').textContent = totalSizeMB.toFixed(1);
                document.getElementById('estimatedTime').textContent = estimatedMinutes;
                
                // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
                document.getElementById('compressDialog').classList.add('show');
                return false; // åœ§ç¸®ãŒå¿…è¦ãªãŸã‚å‡¦ç†ã‚’åœæ­¢
            }
            
            return true; // åœ§ç¸®ä¸è¦ã€ãã®ã¾ã¾å‡¦ç†ç¶™ç¶š
        }
        
        // åœ§ç¸®å‡¦ç†é–‹å§‹
        async function startCompression() {
            document.getElementById('compressDialog').classList.remove('show');
            
            try {
                document.getElementById('progressText').textContent = 'FFmpegã‚’åˆæœŸåŒ–ä¸­...';
                document.getElementById('progress').style.display = 'block';
                await initFFmpeg();
                
                const compressedFiles = [];
                
                for (let i = 0; i < filesNeedingCompression.length; i++) {
                    const file = filesNeedingCompression[i];
                    const inputName = `large_input_${i}.mp4`;
                    const compressedName = `compressed_${i}.mp4`;
                    
                    document.getElementById('progressText').textContent = 
                        `ãƒ•ã‚¡ã‚¤ãƒ« ${i + 1}/${filesNeedingCompression.length} ã‚’åœ§ç¸®ä¸­...`;
                    
                    // åœ§ç¸®å‡¦ç†
                    await ffmpeg.writeFile(inputName, await fetchFile(file));
                    await ffmpeg.exec([
                        '-i', inputName,
                        '-vcodec', 'libx264',
                        '-crf', '28',  // åœ§ç¸®ç‡ï¼ˆ28ã¯é©åº¦ãªåœ§ç¸®ï¼‰
                        '-preset', 'fast',
                        '-acodec', 'aac',
                        '-b:a', '128k',
                        compressedName
                    ]);
                    
                    // åœ§ç¸®ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
                    const compressedData = await ffmpeg.readFile(compressedName);
                    const compressedBlob = new Blob([compressedData.buffer], { type: 'video/mp4' });
                    
                    // åœ§ç¸®ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’Fileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ä½œæˆ
                    const compressedFile = new File([compressedBlob], 
                        file.name.replace('.mp4', '_compressed.mp4'), 
                        { type: 'video/mp4' }
                    );
                    
                    compressedFiles.push(compressedFile);
                    
                    console.log(`åœ§ç¸®å®Œäº†: ${file.name} ${(file.size/1024/1024).toFixed(1)}MB â†’ ${(compressedFile.size/1024/1024).toFixed(1)}MB`);
                    
                    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                    await ffmpeg.deleteFile(inputName);
                    await ffmpeg.deleteFile(compressedName);
                }
                
                // åœ§ç¸®ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã§å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                const otherFiles = selectedConvertFiles.filter(file => file.size <= 100 * 1024 * 1024);
                selectedConvertFiles = [...otherFiles, ...compressedFiles];
                
                // è¡¨ç¤ºã‚’æ›´æ–°
                handleConvertFileSelection(selectedConvertFiles);
                
                // é€šå¸¸ã®å¤‰æ›å‡¦ç†ã‚’é–‹å§‹
                document.getElementById('progressText').textContent = 'åœ§ç¸®å®Œäº†ï¼å¤‰æ›ã‚’é–‹å§‹ã—ã¾ã™...';
                setTimeout(() => proceedWithConversion(), 1000);
                
            } catch (error) {
                console.error('åœ§ç¸®ã‚¨ãƒ©ãƒ¼:', error);
                const result = document.getElementById('result');
                result.className = 'result error';
                result.innerHTML = `
                    <h4>âŒ åœ§ç¸®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h4>
                    <p>${error.message}</p>
                `;
                result.style.display = 'block';
                document.getElementById('progress').style.display = 'none';
            }
        }
        
        // åœ§ç¸®ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelCompression() {
            document.getElementById('compressDialog').classList.remove('show');
            filesNeedingCompression = [];
            
            // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹ã«æˆ»ã™
            document.getElementById('convertBtn').disabled = false;
        }
        
        // åœ§ç¸®å¾Œã®å¤‰æ›å‡¦ç†ç¶™ç¶š
        async function proceedWithConversion() {
            // æ—¢å­˜ã®convertFilesé–¢æ•°ã®ä¸­èº«ã‚’ã“ã“ã«ç§»å‹•ï¼ˆæ¬¡ã§å®Ÿè£…ï¼‰
            await executeConversion();
        }
        
        // MP4â†’MP3å¤‰æ›å‡¦ç†
        async function convertFiles() {
            if (selectedConvertFiles.length === 0) return;
            
            const convertBtn = document.getElementById('convertBtn');
            const progress = document.getElementById('progress');
            const result = document.getElementById('result');
            
            convertBtn.disabled = true;
            progress.style.display = 'none';
            result.style.display = 'none';
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
            if (!checkFileSizes(selectedConvertFiles)) {
                // å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã€ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹
                return; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¸æŠã‚’å¾…ã¤
            }
            
            // é€šå¸¸ã®å¤‰æ›å‡¦ç†ã‚’å®Ÿè¡Œ
            await executeConversion();
        }
        
        // å®Ÿéš›ã®å¤‰æ›å‡¦ç†
        async function executeConversion() {
            const convertBtn = document.getElementById('convertBtn');
            const progress = document.getElementById('progress');
            const result = document.getElementById('result');
            
            try {
                progress.style.display = 'block';
                document.getElementById('progressText').textContent = 'FFmpegã‚’åˆæœŸåŒ–ä¸­...';
                await initFFmpeg();
                
                const quality = document.getElementById('convertQuality').value;
                const convertedFiles = [];
                
                for (let i = 0; i < selectedConvertFiles.length; i++) {
                    const file = selectedConvertFiles[i];
                    const inputName = `input_${i}.mp4`;
                    const outputName = `output_${i}.mp3`;
                    
                    document.getElementById('progressText').textContent = 
                        `ãƒ•ã‚¡ã‚¤ãƒ« ${i + 1}/${selectedConvertFiles.length} ã‚’å¤‰æ›ä¸­...`;
                    
                    await ffmpeg.writeFile(inputName, await fetchFile(file));
                    await ffmpeg.exec([
                        '-i', inputName,
                        '-vn',
                        '-acodec', 'mp3',
                        '-ab', `${quality}k`,
                        outputName
                    ]);
                    
                    const data = await ffmpeg.readFile(outputName);
                    const blob = new Blob([data.buffer], { type: 'audio/mp3' });
                    const url = URL.createObjectURL(blob);
                    
                    const originalName = file.name.replace(/\.[^/.]+$/, "");
                    convertedFiles.push({
                        name: `${originalName}.mp3`,
                        url: url,
                        size: blob.size
                    });
                    
                    await ffmpeg.deleteFile(inputName);
                    await ffmpeg.deleteFile(outputName);
                }
                
                result.className = 'result success';
                result.innerHTML = `
                    <h4>âœ… å¤‰æ›å®Œäº†ï¼</h4>
                    <p>${convertedFiles.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«å¤‰æ›ã•ã‚Œã¾ã—ãŸã€‚</p>
                    ${convertedFiles.map(file => `
                        <div>
                            ğŸµ ${file.name} (${(file.size / (1024*1024)).toFixed(1)}MB)
                            <a href="${file.url}" download="${file.name}" class="download-btn">
                                ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                            </a>
                        </div>
                    `).join('')}
                `;
                result.style.display = 'block';
                
            } catch (error) {
                console.error('å¤‰æ›ã‚¨ãƒ©ãƒ¼:', error);
                result.className = 'result error';
                result.innerHTML = `
                    <h4>âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h4>
                    <p>${error.message}</p>
                `;
                result.style.display = 'block';
            } finally {
                convertBtn.disabled = false;
                progress.style.display = 'none';
            }
        }
        
        // æ–‡å­—èµ·ã“ã—å‡¦ç†
        async function transcribeAudio() {
            if (!selectedTranscribeFile) return;
            
            const transcribeBtn = document.getElementById('transcribeBtn');
            const progress = document.getElementById('progress');
            const result = document.getElementById('result');
            
            transcribeBtn.disabled = true;
            progress.style.display = 'block';
            result.style.display = 'none';
            
            document.getElementById('progressText').textContent = 'æ–‡å­—èµ·ã“ã—ä¸­...';
            document.getElementById('progressFill').style.width = '50%';
            
            try {
                const formData = new FormData();
                formData.append('audio', selectedTranscribeFile);
                formData.append('language', document.getElementById('language').value);
                formData.append('prompt', document.getElementById('prompt').value);
                
                const response = await fetch('/api/transcribe', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
                
                const data = await response.json();
                document.getElementById('progressFill').style.width = '100%';
                
                result.className = 'result transcription-result';
                result.innerHTML = `
                    <h4>âœ… æ–‡å­—èµ·ã“ã—å®Œäº†ï¼</h4>
                    
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-value">${data.processing_time}ç§’</div>
                            <div>å‡¦ç†æ™‚é–“</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${data.duration ? data.duration.toFixed(1) : 'N/A'}ç§’</div>
                            <div>éŸ³å£°æ™‚é–“</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${data.language || 'N/A'}</div>
                            <div>æ¤œå‡ºè¨€èª</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${data.text ? data.text.length : 0}</div>
                            <div>æ–‡å­—æ•°</div>
                        </div>
                    </div>
                    
                    <h5>ğŸ“ æ–‡å­—èµ·ã“ã—çµæœ:</h5>
                    <div class="transcription-text">${data.text || 'ãƒ†ã‚­ã‚¹ãƒˆãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ'}</div>
                    
                    <button class="copy-btn" onclick="copyToClipboard('${data.text ? data.text.replace(/'/g, "\\'") : ''}')">
                        ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼
                    </button>
                    <button class="download-btn" onclick="downloadTranscription('${selectedTranscribeFile.name}', '${data.text ? data.text.replace(/'/g, "\\'") : ''}')">
                        ğŸ“¥ ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </button>
                `;
                result.style.display = 'block';
                
            } catch (error) {
                console.error('æ–‡å­—èµ·ã“ã—ã‚¨ãƒ©ãƒ¼:', error);
                result.className = 'result error';
                result.innerHTML = `
                    <h4>âŒ æ–‡å­—èµ·ã“ã—ã«å¤±æ•—ã—ã¾ã—ãŸ</h4>
                    <p>${error.message}</p>
                    <p>ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                `;
                result.style.display = 'block';
            } finally {
                transcribeBtn.disabled = false;
                progress.style.display = 'none';
            }
        }
        
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
            }).catch(err => {
                console.error('ã‚³ãƒ”ãƒ¼ã‚¨ãƒ©ãƒ¼:', err);
            });
        }
        
        function downloadTranscription(filename, text) {
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename.replace(/\.[^/.]+$/, '') + '_transcription.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹ - ãƒ‡ãƒãƒƒã‚°ç”¨
        window.forceReinitialize = function() {
            console.log('ğŸ”§ å¼·åˆ¶å†åˆæœŸåŒ–ã‚’å®Ÿè¡Œä¸­...');
            try {
                initializeEventListeners();
                preventDefaultDragBehavior();
                console.log('âœ… å¼·åˆ¶å†åˆæœŸåŒ–å®Œäº†');
                
                // ç¢ºèªãƒ†ã‚¹ãƒˆ
                const convertArea = document.getElementById('convertUploadArea');
                if (convertArea) {
                    console.log('ğŸ§ª ç¢ºèªãƒ†ã‚¹ãƒˆ: convertUploadAreaã‚’ã‚¯ãƒªãƒƒã‚¯');
                    convertArea.click();
                }
            } catch (error) {
                console.error('âŒ å¼·åˆ¶å†åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            }
        };
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œã«ç¢ºå®Ÿã«å®Ÿè¡Œ
        if (document.readyState === 'loading') {
            // ã¾ã èª­ã¿è¾¼ã¿ä¸­
            document.addEventListener('DOMContentLoaded', window.forceReinitialize);
        } else if (document.readyState === 'interactive' || document.readyState === 'complete') {
            // ã™ã§ã«èª­ã¿è¾¼ã¿å®Œäº†
            setTimeout(window.forceReinitialize, 100);
        }
        
        console.log('ğŸš€ ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº† - forceReinitialize()ã§æ‰‹å‹•åˆæœŸåŒ–å¯èƒ½');
    </script>
</body>
</html>